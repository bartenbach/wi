#!/bin/bash 
#
#  wi - a lightweight network utility for *nix
#  Copyright (C) 2012 Blake Bartenbach
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

#-------
# Debug
#-------
#set -x

#-----------
# Arguments
#-----------
args="$#"
arg1="$1"
arg2="$2"
arg3="$3"

#-----------
# Variables
#-----------
version='0.0.4-indev'
wi_home="$XDG_CONFIG_HOME/wi"
wi_conf="$wi_home/wi.conf"
iface=""
essid=""
green='\e[0;32m'
red='\e[0;31m'

#------------
# Exit codes
#------------
not_root='10'
no_arguments='20'
no_connection='30'
cannot_put_interface_down='40'
cannot_associate_with_essid='50'
cannot_put_interface_up='60'

#-----------
# Functions
#-----------
function ensure_root {
  if [[ $EUID != 0 ]];then
    echo -e "${red}You must be root to manage network interfaces"
    exit $not_root
  fi
}

#-----------------
# Parse arguments
#-----------------
function parse_arguments {
  if [[ $arg1 == '--version' ]];then
    echo "wi version $version"
    exit 0
  elif [[ $arg1 == '-s' ]] || [[ $arg1 == '--scan' ]];then
    ensure_root
    if [[ -z $arg2 ]];then
      echo "Usage:            -s, --scan [interface]      Scan for wireless networks with [interface]"
      exit $no_arguments
    else
      iface=$arg2
      echo "[Scanning for networks with $iface]"
      scan
      check_scan
      exit $?;
    fi
  elif [[ $arg1 == '-t' ]] || [[ $arg1 == '--test' ]];then
    test_connection
    exit $?
  elif [[ $arg1 == '-c' ]] || [[ $arg1 == '--connect' ]];then
    iface=$arg2
    essid=$arg3
    connect_dhcp
  else
    echo "Usage: wi [arguments]" 
    echo "  -c, --connect interface essid   Connect to essid using interface via a"
    echo "                                  wireless dhcp connection "
    echo "  -t, --test                      Check for a current internet connection "
    echo "  -s, --scan interface            Scan for wireless networks with interface"
    echo "  -h, --help                      Show this menu"
    echo "  --version                       Print the current version of wi"
    exit $no_arguments
  fi  
}

#=================
# Connection code
#=================
function put_interface_down {
  ip link set $iface down >/dev/null 2>&1
}

function check_exit {
  if [ $? != 0 ];then
    echo -e "$red[Connection failed]$reset exit: $1"
    exit $1
  fi  
}

function check_scan {
  if [ $? != 0 ];then
    echo -e "$red[Scan failed]"
    exit 1
  else
    echo -e "$green[Scan complete]"
    exit 0
  fi
}

function put_interface_up {
  ip link set $iface up >/dev/null 2>&1
}

function associate_with_essid {
  iwconfig $iface essid $essid >/dev/null 2>&1
}

function start_dhcp {
  dhcpcd -q $iface >/dev/null 2>&1
}

function kill_dhcpd {
  pkill -9 dhcpcd >/dev/null 2>&1
  rm /run/dhcpcd-$iface.pid >/dev/null 2>&1  
}

function check_connection {
  ping -c1 www.google.com >/dev/null 2>&1
  if [ $? == 0 ];then
    echo -e "$green[Connected to $essid]"
    exit 0
  else
    echo -e "$red[Connection failed]"
    exit $no_connection
  fi
}

#======
# Test
#======
function test_connection {
  ping -c1 www.google.com >/dev/null 2>&1
  if [ $? == 0 ];then
    echo -e "$green[Connected]"
    exit 0
  else
    echo -e "$red[No connection]"
    exit $no_connection
  fi
}

#==========
# Scanning
#==========
function scan {
  ip l s $iface up >/dev/null 2>&1
  iwlist $iface scan | grep --color ESSID | tr -d [:blank:] 
}

#====================
# Configuration file //TODO unimplemented!
#====================
function check_config {
  if [ -f $wi_conf ]; then
    . $wi_conf
  else 
    mkdir -p $wi_home
    touch $wi_conf
  fi
}

#------------------------
# Smart ESSID validation
#------------------------
function validate_essid {
  #//FIXME needs to be passed an interface and needs to set the interface up.  broken.
  let counter=0
  for scanned_essid in `iwlist wlan0 scan | grep ESSID | tr -d [:blank:] | tr -d [ESSID:] | tr -d [\"]`
    do
      essid_array[$counter]=$scanned_essid
      echo $essid_array[$counter]
      (($counter+=1));
    done
}

#--------------------
# Retry to get an IP
#--------------------


#-----------------
# Dhcp connection
#-----------------
function connect_dhcp {
  ensure_root
#//TODO broken.
  validate_essid
  echo -e "[Resetting environment]"
  put_interface_down
  check_exit $cannot_put_interface_down
  kill_dhcpd
  sleep 1
  echo -e "[Associating with $essid]"
  associate_with_essid
  check_exit $cannot_associate_with_essid
  sleep 1
  echo -e "[Putting $iface up]"
  put_interface_up
  check_exit $cannot_put_interface_up
  sleep 2
  echo -e "[Starting dhcp]"
  sleep 1
  start_dhcp
  check_connection
}

#==========================================
#//TODO Endless connectivity testing loop?
#==========================================

#=====
# Run
#=====
parse_arguments
